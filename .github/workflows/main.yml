name: Custom Workflow

on:
   workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version'
        default: 'android12-5.10'
        required: true
      boot_url:
        description: 'URL to download the boot file'
        default: 'http://liaoke.link:5244/d/onedrive/boot.img'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Set kernel version input and env
      id: kernel_version and env
      run: |
            echo "::set-output name=version::${{ github.event.inputs.kernel_version }}"
            env: BOOT_URL: ${{ github.event.inputs.boot_url }}

    - name: Download boot file
      run: | 
       if [ -n "$BOOT_URL" ]; then
        wget -P . "$BOOT_URL" 
       else 
        uses: dawidd6/action-download-artifact@v3
        with: 
         repo: liaoke01/BootIMGExtractAction 
         branch: main 
         workflow: BootIMGExtractAction.yml 
         workflow_conclusion: success 
         name: boot.img 
         path: .
       fi 
       
    - name: Download magiskboot
      run: wget -P . https://github.com/magojohnji/magiskboot-linux/blob/main/x86_64/magiskboot

    - name: Download KernelSU ko file
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: tiann/KernelSU
        branch: kmod
        workflow: build-lkm.yml
        workflow_conclusion: success
        name: ${{ steps.kernel_version.outputs.version }}_kernelsu.ko
        path: .

    - name: Download ksud files
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: tiann/KernelSU
        branch: kmod
        workflow: build-manager.yml
        workflow_conclusion: success
        name: ./ksud-x86_64-linux-android
        path: .
        
    - name: Download manager files
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: tiann/KernelSU
        branch: kmod
        workflow: build-manager.yml
        workflow_conclusion: success
        name: manager
        path: .

    - name: Move file 
      run: mv ./x86_64-linux-android/release/ksud .
      
    - name: ls
      run: ls
      
    - name: Set execute permissions 
      run: | 
             chmod +x ksud
             chmod +x magiskboot

    - name: patch boot
      run: ksud boot-patch -b boot.img -m kernelsu.ko

    - uses: actions/checkout@v2
    - name: Upload APK and IMG files
      uses: actions/upload-artifact@v2
      with:
        path: |
          *.apk
          *.img
      
